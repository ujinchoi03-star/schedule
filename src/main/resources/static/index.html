<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•‘í”„ ì‹œê°„í‘œ (ìë™ ìƒì„±ê¸°)</title>
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
        h1 { text-align: center; color: #333; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; margin-top: 20px; }
        button:hover { background-color: #0056b3; }

        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #e9ecef; }
        .option-title { background-color: #343a40; color: white; padding: 10px; border-radius: 5px; margin-top: 30px; }
        .checkbox-group label { display: inline-block; width: auto; margin-right: 10px; font-weight: normal; }
    </style>
</head>
<body>

<h1>ğŸ“… í•‘í”„ ì‹œê°„í‘œ ìƒì„±ê¸° (ë°±íŠ¸ë˜í‚¹ ver)</h1>

<div class="card">
    <h3>ì¡°ê±´ì„ ì…ë ¥í•˜ì„¸ìš”</h3>

    <label>ìµœëŒ€ ê³µê°• ì‹œê°„ (ì‹œê°„)</label>
    <input type="number" id="maxGapHours" value="3">

    <label>ëª©í‘œ í•™ì </label>
    <input type="number" id="targetCredit" value="15">

    <label>ìµœì†Œ ê°•ì˜ í‰ì  (0~5)</label>
    <input type="number" id="minRating" step="0.1" value="3.5">

    <label>ì„ í˜¸í•˜ëŠ” ìš”ì¼ (ë³µìˆ˜ ì„ íƒ)</label>
    <div class="checkbox-group">
        <label><input type="checkbox" name="days" value="Mon" checked> ì›”</label>
        <label><input type="checkbox" name="days" value="Tue" checked> í™”</label>
        <label><input type="checkbox" name="days" value="Wed" checked> ìˆ˜</label>
        <label><input type="checkbox" name="days" value="Thu" checked> ëª©</label>
        <label><input type="checkbox" name="days" value="Fri" checked> ê¸ˆ</label>
    </div>

    <label>ì¶”ê°€ ì˜µì…˜</label>
    <div class="checkbox-group" style="margin-top: 5px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
        <label style="font-weight: bold; color: #d63384;">
            <input type="checkbox" id="onlyMajor"> ì „ê³µ ìˆ˜ì—…ë§Œ ë“£ê¸° ğŸ“
        </label>

        <hr style="margin: 8px 0; border: 0; border-top: 1px solid #ddd;">

        <label style="font-size: 0.9em; margin-bottom: 5px; display:block; color: #555;">ğŸš« ì œì™¸í•˜ê³  ì‹¶ì€ ìœ í˜• ì„ íƒ:</label>
        <label><input type="checkbox" name="avoid" value="ì˜ì–´"> ì˜ì–´ì „ìš©</label>
        <label><input type="checkbox" name="avoid" value="PBL"> IC-PBL</label>
        <label><input type="checkbox" name="avoid" value="E-ëŸ¬ë‹"> E-ëŸ¬ë‹</label>
        <label><input type="checkbox" name="avoid" value="SMART"> SMART-F/B</label>

        <hr style="margin: 8px 0; border: 0; border-top: 1px solid #ddd;">
        <label style="color: #6610f2; font-weight: bold;">
            <input type="checkbox" id="excludeNoTime"> ì‹œê°„ ë¯¸ì§€ì •(ì˜¨ë¼ì¸) ì œì™¸ â°
        </label>
    </div>

    <button onclick="generateTimeTable()">ì‹œê°„í‘œ ì§œì£¼ì„¸ìš”! ğŸš€</button>
</div>

<div id="resultContainer"></div>

<script>
    async function generateTimeTable() {
        const maxGapHours = document.getElementById('maxGapHours').value;
        const targetCredit = document.getElementById('targetCredit').value;
        const minRating = document.getElementById('minRating').value;

        // 1. ìš”ì¼ ì²´í¬ë°•ìŠ¤ ê°’ ê°€ì ¸ì˜¤ê¸°
        const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
            .map(cb => cb.value);

        // 2. [NEW] ì „ê³µ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸° (true/false)
        const onlyMajor = document.getElementById('onlyMajor') ? document.getElementById('onlyMajor').checked : false;

        // 3. [NEW] ê¸°í”¼ í‚¤ì›Œë“œ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: ["ì˜ì–´", "PBL"])
        const avoidKeywords = Array.from(document.querySelectorAll('input[name="avoid"]:checked'))
            .map(cb => cb.value);

        const excludeNoTime = document.getElementById('excludeNoTime') ? document.getElementById('excludeNoTime').checked : false;
        const requestData = {
            maxGapHours: parseInt(maxGapHours),
            preferredDays: checkedDays,
            targetCredit: parseInt(targetCredit),
            minRating: parseFloat(minRating),
            // ğŸ‘‡ ë°±ì—”ë“œë¡œ ë³´ë‚´ëŠ” ìƒˆë¡œìš´ ì¹œêµ¬ë“¤!
            onlyMajor: onlyMajor,
            avoidKeywords: avoidKeywords,
            excludeNoTime: excludeNoTime
        };

        try {
            const response = await fetch('/api/timetable/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜!");

            const scheduleOptions = await response.json();
            renderOptions(scheduleOptions);

        } catch (error) {
            alert("ì‹œê°„í‘œ ìƒì„± ì‹¤íŒ¨: " + error.message);
        }
    }

    // ì—¬ëŸ¬ ê°œì˜ ì‹œê°„í‘œ ì˜µì…˜ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    // ì—¬ëŸ¬ ê°œì˜ ì‹œê°„í‘œ ì˜µì…˜ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ì‹œê°„ í‘œì‹œ ë²„ì „)
    // ì—¬ëŸ¬ ê°œì˜ ì‹œê°„í‘œ ì˜µì…˜ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (í•™ì  ê³„ì‚° ì˜¤ë¥˜ ìˆ˜ì • & ì •ë ¬ ì¶”ê°€ ver)
    // ì—¬ëŸ¬ ê°œì˜ ì‹œê°„í‘œ ì˜µì…˜ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° & í†µí•© ë³´ê¸° ëª¨ë“œ)
    function renderOptions(options) {
        const container = document.getElementById('resultContainer');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        if (options.length === 0) {
            container.innerHTML = '<div class="card"><h3>ğŸ˜­ ì¡°ê±´ì— ë§ëŠ” ì‹œê°„í‘œ ì¡°í•©ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.</h3></div>';
            return;
        }

        const dayKorean = { "Mon": "ì›”", "Tue": "í™”", "Wed": "ìˆ˜", "Thu": "ëª©", "Fri": "ê¸ˆ", "Sat": "í† " };
        const dayOrder = { "Mon": 1, "Tue": 2, "Wed": 3, "Thu": 4, "Fri": 5, "Sat": 6 };

        options.forEach((schedule, index) => {

            // 1. ê°™ì€ ìˆ˜ì—…ë¼ë¦¬ ë¬¶ê¸° (Grouping)
            const groupedMap = new Map();
            let totalCredit = 0;

            schedule.forEach(lecture => {
                const key = lecture.name + lecture.professor;

                if (!groupedMap.has(key)) {
                    // ì²˜ìŒ ë°œê²¬í•œ ìˆ˜ì—…ì´ë©´ ë“±ë¡
                    groupedMap.set(key, {
                        name: lecture.name,
                        professor: lecture.professor,
                        credit: lecture.credit,
                        rating: lecture.rating,
                        times: [] // ì‹œê°„ë“¤ì„ ë‹´ì„ ë¦¬ìŠ¤íŠ¸
                    });
                    totalCredit += lecture.credit; // í•™ì ì€ í•œ ë²ˆë§Œ ë”í•˜ê¸°
                }

                // ì‹œê°„ ì •ë³´ ì¶”ê°€
                groupedMap.get(key).times.push({
                    day: lecture.day,
                    start: lecture.startTime,
                    end: lecture.endTime
                });
            });

            // 2. í…Œì´ë¸” ê·¸ë¦¬ê¸°
            let tableRows = '';

            // ë§µì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const courseList = Array.from(groupedMap.values());

            courseList.forEach(course => {
                // ì‹œê°„ ì •ë³´ë¥¼ ì˜ˆì˜ê²Œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ì˜ˆ: ì›”(10:00~12:00), í™”(10:00~12:00))
                // ìš”ì¼ ìˆœì„œëŒ€ë¡œ ì •ë ¬ ë¨¼ì € í•˜ê¸°
                course.times.sort((a, b) => dayOrder[a.day] - dayOrder[b.day]);

                const timeString = course.times.map(t => {

                    if (t.start === -1) {
                        return `<span style="display:inline-block; background:#e9ecef; color:#495057; padding:2px 6px; border-radius:4px; margin:2px; font-size:0.85em;">
                                    ì‹œê°„ ë¯¸ì§€ì • ê°•ì¢Œ ğŸ•’
                                </span>`;
                    }
                    const startHour = String(t.start + 8).padStart(2, '0') + ":00";
                    const endHour = String(t.end + 9).padStart(2, '0') + ":00";
                    // ëª¨ë°”ì¼ì—ì„œë„ ë³´ê¸° ì¢‹ê²Œ ë±ƒì§€ ìŠ¤íƒ€ì¼ë¡œ ê°ì‹¸ê¸°
                    return `<span style="display:inline-block; background:#f1f3f5; padding:2px 6px; border-radius:4px; margin:2px; font-size:0.85em;">
                                ${dayKorean[t.day]} ${startHour}~${endHour}
                            </span>`;
                }).join('<br>'); // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„

                tableRows += `
                    <tr>
                        <td style="vertical-align: middle;">${course.name}</td>
                        <td style="vertical-align: middle;">${course.professor}</td>
                        <td style="text-align: left;">${timeString}</td>
                        <td style="vertical-align: middle;">${course.credit}í•™ì </td>
                        <td style="vertical-align: middle;">â­ ${course.rating}</td>
                    </tr>
                `;
            });

            const html = `
                <div class="card">
                    <div class="option-title">âœ¨ ì¶”ì²œ ì‹œê°„í‘œ ì˜µì…˜ ${index + 1} (ì´ ${totalCredit}í•™ì )</div>
                    <table>
                        <thead>
                            <tr>
                                <th width="25%">ê°•ì˜ëª…</th>
                                <th width="15%">êµìˆ˜</th>
                                <th width="40%">ì‹œê°„</th> <th width="10%">í•™ì </th>
                                <th width="10%">í‰ì </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                            <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td colspan="3" style="text-align: right; padding-right: 20px;">ì´ í•©ê³„</td>
                                <td style="color: #d63384;">${totalCredit}í•™ì </td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML += html;
        });
    }
</script>
</body>
</html>